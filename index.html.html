<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="utf-8" />
    <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
    <title>P2P Call App + FreeTURN</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: #000;
            overflow: hidden;
            touch-action: none;
        }

        /* Glass Panel */
        .glass-panel {
            background: rgba(20, 20, 20, 0.6);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Video Styles */
        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .mirror {
            transform: scaleX(-1);
        }

        /* Animations */
        .slide-up-enter-active,
        .slide-up-leave-active {
            transition: transform 0.3s ease;
        }

        .slide-up-enter-from,
        .slide-up-leave-to {
            transform: translateY(100%);
        }

        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scroll::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 10px;
        }

        .custom-scroll::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
    </style>
</head>

<body class="text-white h-[100dvh] w-screen relative">
    <div id="app" class="h-full w-full relative flex flex-col">
        <div v-if="!hasInteracted"
            class="absolute inset-0 z-50 bg-slate-900 flex flex-col items-center justify-center p-6 text-center space-y-6">
            <div
                class="w-20 h-20 bg-blue-600 rounded-full flex items-center justify-center shadow-[0_0_30px_rgba(37,99,235,0.5)] animate-pulse">
                <i class="fa-solid fa-phone text-3xl"></i>
            </div>
            <h1 class="text-2xl font-bold">Видеозвонок P2P</h1>
            <p class="text-slate-400 text-sm max-w-xs">Включена поддержка FreeTURN и расширенный список STUN серверов.
            </p>

            <button @click="startApp"
                class="bg-white text-slate-900 px-8 py-4 rounded-full font-bold text-lg active:scale-95 transition shadow-xl">
                Начать (Разрешить доступ)
            </button>
        </div>

        <div v-else class="relative h-full w-full overflow-hidden">
            <div class="absolute inset-0 bg-slate-800 z-0">
                <video ref="remoteVideoRef" autoplay playsinline class="w-full h-full object-cover"></video>

                <div v-if="!remoteStreamActive"
                    class="absolute inset-0 flex flex-col items-center justify-center bg-slate-900/90 backdrop-blur-sm z-10">
                    <div class="text-center space-y-4 p-6">
                        <p
                            class="text-slate-500 text-sm font-mono bg-slate-800 px-3 py-1 rounded-full inline-block mb-2">
                            Ваш ID: <span class="text-white select-all">{{ myId }}</span>
                            <i @click="copyId" class="fa-regular fa-copy ml-2 cursor-pointer active:text-green-400"></i>
                        </p>
                        <h2 class="text-2xl font-bold">
                            <span v-if="isCalling" class="animate-pulse">Вызов...</span>
                            <span v-else-if="isConnected">Соединение установлено!</span>
                            <span v-else>Ожидание...</span>
                        </h2>
                        <div v-if="!isConnected" class="flex gap-2 mt-4 max-w-xs mx-auto">
                            <input v-model="targetId" placeholder="ID друга"
                                class="bg-slate-800 border border-slate-600 rounded-lg px-4 py-3 w-full text-sm outline-none focus:border-blue-500 transition">
                            <button @click="connectToPeer" :disabled="!targetId || isCalling"
                                class="bg-blue-600 w-12 rounded-lg flex items-center justify-center active:bg-blue-700 disabled:opacity-50">
                                <i class="fa-solid" :class="isCalling ? 'fa-circle-notch fa-spin' : 'fa-phone'"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div v-show="mediaState.video"
                class="absolute top-4 right-4 w-28 h-40 md:w-48 md:h-32 bg-black rounded-xl overflow-hidden shadow-2xl z-20 border border-white/20 transition-all">
                <video ref="localVideoRef" autoplay playsinline muted class="w-full h-full object-cover mirror"></video>
            </div>

            <div class="absolute top-0 left-0 right-0 p-4 z-20 flex justify-between items-start pointer-events-none">
                <div
                    class="bg-black/40 backdrop-blur px-3 py-1 rounded-full text-xs font-medium border border-white/10 text-white/80 pointer-events-auto">
                    <span class="w-2 h-2 rounded-full inline-block mr-2"
                        :class="isConnected ? 'bg-green-500' : 'bg-red-500'"></span>
                    {{ statusText }}
                </div>
            </div>

            <div
                class="absolute bottom-0 left-0 right-0 pb-8 pt-4 px-6 glass-panel z-30 flex justify-around items-center">
                <button @click="toggleAudio" class="flex flex-col items-center gap-1 group">
                    <div class="w-12 h-12 rounded-full flex items-center justify-center transition active:scale-90"
                        :class="mediaState.audio ? 'bg-slate-700/50 text-white' : 'bg-white text-slate-900'">
                        <i class="fa-solid" :class="mediaState.audio ? 'fa-microphone' : 'fa-microphone-slash'"></i>
                    </div>
                    <span class="text-[10px] opacity-70">Звук</span>
                </button>
                <button @click="endCall" class="flex flex-col items-center gap-1 group">
                    <div
                        class="w-14 h-14 rounded-full bg-red-600 flex items-center justify-center text-white shadow-lg shadow-red-900/50 active:scale-90 transition">
                        <i class="fa-solid fa-phone-slash text-xl"></i>
                    </div>
                </button>
                <button @click="toggleVideo" class="flex flex-col items-center gap-1 group">
                    <div class="w-12 h-12 rounded-full flex items-center justify-center transition active:scale-90"
                        :class="mediaState.video ? 'bg-slate-700/50 text-white' : 'bg-white text-slate-900'">
                        <i class="fa-solid" :class="mediaState.video ? 'fa-video' : 'fa-video-slash'"></i>
                    </div>
                    <span class="text-[10px] opacity-70">Камера</span>
                </button>
                <button @click="isChatOpen = !isChatOpen" class="flex flex-col items-center gap-1 group relative">
                    <div
                        class="w-12 h-12 rounded-full bg-slate-700/50 flex items-center justify-center transition active:scale-90">
                        <i class="fa-solid fa-comment-dots text-lg"></i>
                    </div>
                    <span v-if="unreadCount > 0"
                        class="absolute top-0 right-0 w-5 h-5 bg-blue-500 rounded-full text-[10px] flex items-center justify-center border-2 border-slate-900 font-bold">
                        {{ unreadCount }}
                    </span>
                    <span class="text-[10px] opacity-70">Чат</span>
                </button>
            </div>

            <transition name="slide-up">
                <div v-if="isChatOpen"
                    class="absolute inset-x-0 bottom-0 top-20 bg-slate-900 z-40 rounded-t-3xl flex flex-col shadow-[0_-10px_40px_rgba(0,0,0,0.5)] border-t border-white/10">
                    <div class="p-4 flex justify-between items-center border-b border-white/5">
                        <h3 class="font-bold text-lg">Чат</h3>
                        <button @click="isChatOpen = false"
                            class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    </div>
                    <div class="flex-1 overflow-y-auto p-4 space-y-3 custom-scroll" ref="chatBoxRef">
                        <div v-if="messages.length === 0" class="text-center text-slate-500 mt-10">
                            Напишите первое сообщение...
                        </div>
                        <div v-for="(msg, i) in messages" :key="i" class="flex flex-col"
                            :class="msg.isMe ? 'items-end' : 'items-start'">
                            <div class="px-4 py-2 rounded-2xl max-w-[80%] text-sm"
                                :class="msg.isMe ? 'bg-blue-600 text-white rounded-br-none' : 'bg-slate-800 text-slate-200 rounded-bl-none'">
                                {{ msg.text }}
                            </div>
                            <span class="text-[10px] text-slate-500 mt-1 px-1">{{ msg.time }}</span>
                        </div>
                    </div>
                    <div class="p-3 bg-slate-800/50 pb-8">
                        <form @submit.prevent="sendMessage" class="flex gap-2">
                            <input v-model="newMessage" placeholder="Сообщение..."
                                class="flex-1 bg-slate-700 border-none rounded-full px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none text-white">
                            <button type="submit" :disabled="!newMessage.trim() || !isConnected"
                                class="w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center disabled:opacity-50">
                                <i class="fa-solid fa-paper-plane text-sm"></i>
                            </button>
                        </form>
                    </div>
                </div>
            </transition>
        </div>
    </div>

    <script>
        const { createApp, ref, reactive, nextTick, shallowRef, onBeforeUnmount, watch } = Vue;

        createApp({
            setup() {
                // --- State ---
                const hasInteracted = ref(false);
                const myId = ref('...');
                const targetId = ref('');
                const statusText = ref('Ожидание');

                const isConnected = ref(false);
                const isCalling = ref(false);
                const isChatOpen = ref(false);
                const remoteStreamActive = ref(false);
                const unreadCount = ref(0);

                const mediaState = reactive({ audio: true, video: true });
                const messages = ref([]);
                const newMessage = ref('');

                // --- Non-Reactive Instances ---
                const localStream = shallowRef(null);
                let peer = null;
                let conn = null;
                let mediaCall = null;

                // --- DOM Refs ---
                const localVideoRef = ref(null);
                const remoteVideoRef = ref(null);
                const chatBoxRef = ref(null);

                // --- 1. START APP (User Interaction) ---
                const startApp = async () => {
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({
                            video: { facingMode: 'user', width: { ideal: 640 }, height: { ideal: 480 } },
                            audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: true }
                        });
                        localStream.value = stream;
                        hasInteracted.value = true;

                        await nextTick();
                        if (localVideoRef.value) {
                            localVideoRef.value.srcObject = stream;
                            localVideoRef.value.muted = true;
                            localVideoRef.value.volume = 0;
                        }
                        initPeer();
                    } catch (e) {
                        alert("Ошибка доступа к камере: " + e.message + "\nУбедитесь, что сайт открыт через HTTPS или localhost.");
                    }
                };

                // --- 2. PEER LOGIC (STUN + FREETURN) ---
                const initPeer = () => {
                    peer = new Peer(null, {
                        debug: 1,
                        config: {
                            // Оптимизация: собираем кандидатов быстрее
                            iceCandidatePoolSize: 10,
                            iceServers: [
                                // 1. Google STUN (Надежные)
                                { urls: "stun:stun.l.google.com:19302" },
                                { urls: "stun:stun1.l.google.com:19302" },
                                { urls: "stun:stun2.l.google.com:19302" },
                                { urls: "stun:stun3.l.google.com:19302" },
                                { urls: "stun:stun4.l.google.com:19302" },

                                // 2. Community STUN
                                { urls: "stun:stun.counterpath.com:3478" },
                                { urls: "stun:stun.voipawesome.com:3478" },
                                { urls: "stun:stun.nextcloud.com:443" },

                                // 3. FreeTURN (Для обхода NAT) - Бесплатный сервис
                                {
                                    urls: [
                                        "turn:global.turn.metered.ca:80",
                                        "turn:global.turn.metered.ca:443",
                                        "turn:global.turn.metered.ca:443?transport=tcp"
                                    ],
                                    username: "openrelayproject",
                                    credential: "openrelayproject"
                                }
                            ]







                        }
                            ]
            }
        });

        peer.on('open', (id) => {
            myId.value = id;
            statusText.value = 'В сети';
        });

        peer.on('error', (err) => {
            console.error("PeerJS Error:", err);
            statusText.value = 'Ошибка сети';
            isCalling.value = false;
        });

        // ВХОДЯЩИЙ ЗВОНОК
        peer.on('call', (incomingCall) => {
            if (mediaCall && mediaCall.peer !== incomingCall.peer) {
                try { mediaCall.close(); } catch (e) { }
            }

            const accept = confirm(`Входящий звонок от ${incomingCall.peer}. Принять?`);
            if (!accept) {
                try { incomingCall.close(); } catch (e) { }
                return;
            }

            statusText.value = 'Соединение...';

            setupMediaCallEvents(incomingCall);
            // Важно: проверяем наличие потока
            if (localStream.value) {
                incomingCall.answer(localStream.value);
            } else {
                console.error("No local stream found");
            }

            if (!conn || conn.peer !== incomingCall.peer) {
                const connection = peer.connect(incomingCall.peer, { reliable: true });
                setupDataConnEvents(connection);
            }
        });

        // ВХОДЯЩЕЕ DATA СОЕДИНЕНИЕ
        peer.on('connection', (connection) => {
            if (conn && conn.peer !== connection.peer) {
                try { conn.close(); } catch (e) { }
            }
            setupDataConnEvents(connection);
        });
                };

        // --- 3. ИСХОДЯЩЕЕ СОЕДИНЕНИЕ ---
        const connectToPeer = () => {
            const destId = targetId.value.trim();
            if (!destId || destId === myId.value || isCalling.value) return;

            // Защита: если peer не готов
            if (!peer || peer.destroyed) {
                alert("Ошибка: P2P сеть не инициализирована.");
                return;
            }

            // Очистка старого
            endCall();

            isCalling.value = true;
            statusText.value = 'Звоним...';

            // 1. Data Connection
            const connection = peer.connect(destId, { reliable: true });
            setupDataConnEvents(connection);

            // 2. Media Call
            if (localStream.value) {
                const callInstance = peer.call(destId, localStream.value);
                setupMediaCallEvents(callInstance);
            }
        };

        // --- 4. ОБРАБОТЧИКИ СОБЫТИЙ ---

        // Чат/Данные
        const setupDataConnEvents = (connection) => {
            // Закрываем старое, если есть
            if (conn && conn.open && conn.peer !== connection.peer) {
                try { conn.close(); } catch (e) { }
            }

            conn = connection;
            conn.on('open', () => {
                isConnected.value = true;
                isCalling.value = false;
                targetId.value = conn.peer;
                statusText.value = 'Соединение установлено';
            });

            conn.on('data', (data) => {
                messages.value.push({ text: data, isMe: false, time: new Date().toLocaleTimeString().slice(0, 5) });
                if (!isChatOpen.value) unreadCount.value++;
                scrollToBottom();
            });

            conn.on('close', () => {
                if (remoteStreamActive.value) {
                    statusText.value = 'Чат отключен. Звонок активен.';
                } else {
                    endCallState();
                }
            });

            conn.on('error', (e) => {
                console.error("Data Connection Error:", e);
            });
        };

        // Медиа/Звонок
        const setupMediaCallEvents = (newCall) => {
            mediaCall = newCall;
            mediaCall.on('stream', (stream) => {
                remoteStreamActive.value = true;
                isCalling.value = false;

                nextTick(() => {
                    if (remoteVideoRef.value) {
                        remoteVideoRef.value.srcObject = stream;
                        // Попытка автовоспроизведения
                        remoteVideoRef.value.play().catch(e => {
                            console.error("Autoplay prevented:", e);
                            statusText.value = 'Нажмите на видео для звука!';
                        });
                    }
                });
                statusText.value = 'Идет разговор';
            });

            mediaCall.on('close', () => {
                remoteStreamActive.value = false;
                if (isConnected.value) {
                    statusText.value = 'Видео отключено. Чат активен.';
                } else {
                    endCallState();
                }
                if (remoteVideoRef.value) remoteVideoRef.value.srcObject = null;
            });

            mediaCall.on('error', (e) => {
                console.error("Media Call Error:", e);
                isCalling.value = false;
                remoteStreamActive.value = false;
                statusText.value = 'Ошибка звонка';
            });
        };

        // --- 5. УПРАВЛЕНИЕ ---
        const toggleAudio = () => {
            const track = localStream.value?.getAudioTracks()[0];
            if (track) {
                track.enabled = !track.enabled;
                mediaState.audio = track.enabled;
            }
        };

        const toggleVideo = () => {
            const track = localStream.value?.getVideoTracks()[0];
            if (track) {
                track.enabled = !track.enabled;
                mediaState.video = track.enabled;
            }
        };

        const sendMessage = () => {
            if (!newMessage.value.trim() || !isConnected.value) return;
            conn.send(newMessage.value);
            messages.value.push({ text: newMessage.value, isMe: true, time: new Date().toLocaleTimeString().slice(0, 5) });
            newMessage.value = '';
            scrollToBottom();
        };

        const endCall = () => {
            try { if (mediaCall) mediaCall.close(); } catch (e) { }
            try { if (conn) conn.close(); } catch (e) { }
            endCallState();
        };

        const endCallState = () => {
            isConnected.value = false;
            isCalling.value = false;
            remoteStreamActive.value = false;
            mediaCall = null;
            conn = null;
            statusText.value = 'Соединение завершено';
        }

        const scrollToBottom = () => {
            nextTick(() => {
                if (chatBoxRef.value) chatBoxRef.value.scrollTop = chatBoxRef.value.scrollHeight;
            });
        };

        const copyId = async () => {
            try {
                await navigator.clipboard.writeText(myId.value);
                const originalStatus = statusText.value;
                statusText.value = 'ID Скопирован!';
                setTimeout(() => statusText.value = originalStatus, 2000);
            } catch (err) {
                console.error('Ошибка копирования:', err);
                statusText.value = 'Ошибка копирования';
            }
        };

        // Watchers
        watch(isChatOpen, (val) => {
            if (val) unreadCount.value = 0;
            if (val) scrollToBottom();
        });

        // Lifecycle cleanup
        onBeforeUnmount(() => {
            if (peer) peer.destroy();
            if (localStream.value) {
                localStream.value.getTracks().forEach(track => track.stop());
            }
        });

        // Доп. очистка при закрытии вкладки
        window.addEventListener('beforeunload', () => {
            if (peer) peer.destroy();
        });

        return {
            hasInteracted, startApp,
            myId, targetId, statusText, isConnected, isCalling,
            localVideoRef, remoteVideoRef, chatBoxRef,
            mediaState, messages, newMessage, isChatOpen, unreadCount,
            remoteStreamActive,
            connectToPeer, sendMessage, toggleAudio, toggleVideo, endCall, copyId
        };
            }
        }).mount('#app');
    </script>
</body>

</html>